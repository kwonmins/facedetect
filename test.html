<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì›¹ìº  ì–¼êµ´í˜• ë¶„ì„</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
      body {
        text-align: center;
        font-family: Arial, sans-serif;
      }
      video {
        border: 2px solid black;
        margin: 20px;
      }
      #result {
        font-size: 20px;
        font-weight: bold;
        margin-top: 10px;
      }
      #probabilities {
        margin-top: 10px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h1>Teachable Machine ì–¼êµ´í˜• ë¶„ì„</h1>
    <video id="webcam" autoplay playsinline width="300" height="300"></video>
    <p id="result">ë¶„ì„ ì¤‘...</p>
    <p id="probabilities"></p>

    <script>
      let model;
      let webcamElement = document.getElementById("webcam");

      // ì–¼êµ´í˜• í´ë˜ìŠ¤ (Teachable Machineì—ì„œ í•™ìŠµí•œ ìˆœì„œëŒ€ë¡œ ì„¤ì •)
      const faceShapes = ["ë‘¥ê·¼í˜•", "ê°ì§„í˜•", "ê¸´ ì–¼êµ´í˜•", "í•˜íŠ¸í˜•", "ê³„ë€í˜•"];

      // 1ï¸âƒ£ ëª¨ë¸ ë¡œë“œ
      async function loadModel() {
        model = await tf.loadLayersModel("model.json"); // ëª¨ë¸ ê²½ë¡œ ì„¤ì •
        console.log("âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!");
      }

      // 2ï¸âƒ£ ì›¹ìº  í™œì„±í™”
      async function setupWebcam() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        webcamElement.srcObject = stream;
        console.log("ğŸ¥ ì›¹ìº  ì‹œì‘!");
      }

      // 3ï¸âƒ£ ì‹¤ì‹œê°„ ì˜ˆì¸¡ í•¨ìˆ˜
      async function predict() {
        if (!model) {
          document.getElementById("result").innerText = "â³ ëª¨ë¸ ë¡œë”© ì¤‘...";
          return;
        }

        // ì›¹ìº ì—ì„œ ì´ë¯¸ì§€ ìº¡ì²˜í•˜ì—¬ ëª¨ë¸ ì…ë ¥ í˜•íƒœë¡œ ë³€í™˜
        const videoTensor = tf.browser
          .fromPixels(webcamElement)
          .resizeNearestNeighbor([224, 224]) // ëª¨ë¸ ì…ë ¥ í¬ê¸°ì— ë§ì¶”ê¸°
          .toFloat()
          .expandDims(0); // ë°°ì¹˜ ì°¨ì› ì¶”ê°€

        const prediction = model.predict(videoTensor);
        const resultArray = await prediction.data(); // ì˜ˆì¸¡ëœ í™•ë¥  ê°’ ê°€ì ¸ì˜¤ê¸°

        // ê°€ì¥ ë†’ì€ í™•ë¥ ì„ ê°€ì§„ ì¸ë±ìŠ¤ ì°¾ê¸°
        const maxIndex = resultArray.indexOf(Math.max(...resultArray));
        const predictedShape = faceShapes[maxIndex]; // ì˜ˆì¸¡ëœ ì–¼êµ´í˜•

        // ê° ì–¼êµ´í˜•ì˜ í™•ë¥ ì„ ë°±ë¶„ìœ¨(%)ë¡œ ë³€í™˜
        let probabilitiesText = "";
        resultArray.forEach((prob, index) => {
          probabilitiesText += `${faceShapes[index]}: ${(prob * 100).toFixed(
            2
          )}%<br>`;
        });

        // ê²°ê³¼ ì¶œë ¥
        document.getElementById(
          "result"
        ).innerText = `ì˜ˆì¸¡ëœ ì–¼êµ´í˜•: ${predictedShape}`;
        document.getElementById("probabilities").innerHTML = probabilitiesText;

        console.log("ì˜ˆì¸¡ ê°’:", resultArray);
      }

      // 4ï¸âƒ£ ì‹¤í–‰ (ëª¨ë¸ ë¡œë“œ â†’ ì›¹ìº  ì‹¤í–‰ â†’ ì˜ˆì¸¡ ì‹¤í–‰)
      async function init() {
        await loadModel();
        await setupWebcam();
        setInterval(predict, 2000); // 2ì´ˆë§ˆë‹¤ ì˜ˆì¸¡ ì‹¤í–‰
      }

      init();
    </script>
  </body>
</html>
